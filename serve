#! /bin/sh
# serve

set -e

export DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock
export PODMAN_COMPOSE_WARNING_LOGS=false
export PODMAN_COMPOSE_PROVIDER=podman-compose

if [ -d "$HOME/bin" ] 
then
	PATH="$HOME/bin:$PATH"
fi

if [ -d "$HOME/.local/bin" ] 
then
	PATH="$HOME/.local/bin:$PATH"
fi

usage() {
	echo "Usage: $0 []"
	echo
	exit 1
}

while getopts "" opt
do
	case $opt in
		*) usage ;;
	esac
done

database_container="csdha-database-pod-database"
k8s_db_files="secret.yaml pvc.yaml database.yaml"
container_name=$(podman ps --filter "name=$database_container" --format "{{.Names}}")
if [ -z "$container_name" ]; then
	for yaml_file in $k8s_db_files
	do
		podman kube play --replace k8s/$yaml_file
	done
fi

podman build -f container/base/Dockerfile -t alpine-laravel:1.0 .
podman build -f container/web/Dockerfile -t laravel-web:1.0 .
podman build -f container/queue/Dockerfile -t laravel-queue:1.0 .
podman build -f container/migrate/Dockerfile -t laravel-migrate:1.0 .
k8s_web_files="migrate.yaml web-user.yaml web-admin.yaml queue.yaml"
for yaml_file in $k8s_web_files
do
	podman kube play --replace k8s/$yaml_file
done
# docker-compose up -d
podman image prune -f 

